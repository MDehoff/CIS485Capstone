import streamlit as st
import pandas as pd
import numpy as np

st.set_page_config(page_title="Pitcher Health Dashboard", layout="wide")

st.title("âš¾ Pitcher Performance & Health Dashboard")

st.markdown("Upload your pitching CSV file to analyze averages and health indicators.")

uploaded_file = st.file_uploader("Upload CSV", type=["csv"])

if uploaded_file is not None:
    df = pd.read_csv(uploaded_file)

    st.subheader("Raw Data")
    st.dataframe(df)

    st.subheader("ğŸ“Š Averages")

    numeric_cols = [
        "velocity_mph",
        "spin_rate_rpm",
        "horiz_break_in",
        "vert_break_in",
        "release_height_ft",
        "release_side_ft",
        "release_consistency_score"
    ]

    averages = df[numeric_cols].mean()
    st.write(averages)

    st.subheader("ğŸ“‰ Release Point Variability (Injury Indicator)")

    release_height_std = df["release_height_ft"].std()
    release_side_std = df["release_side_ft"].std()

    st.write("Release Height Std Dev:", round(release_height_std, 3))
    st.write("Release Side Std Dev:", round(release_side_std, 3))

    st.subheader("âš ï¸ Health Risk Flags")

    velocity_drop = df["velocity_mph"].iloc[0] - df["velocity_mph"].iloc[-1]
    spin_drop = df["spin_rate_rpm"].iloc[0] - df["spin_rate_rpm"].iloc[-1]
    consistency_avg = df["release_consistency_score"].mean()

    risk_messages = []

    if velocity_drop > 1.5:
        risk_messages.append("âš ï¸ Significant velocity drop detected.")

    if spin_drop > 150:
        risk_messages.append("âš ï¸ Spin rate drop detected.")

    if release_height_std > 0.15:
        risk_messages.append("âš ï¸ Release height variability increasing.")

    if consistency_avg < 88:
        risk_messages.append("âš ï¸ Low release consistency.")

    if len(risk_messages) == 0:
        st.success("âœ… No major red flags detected.")
    else:
        for msg in risk_messages:
            st.error(msg)

    st.subheader("ğŸ§  Key Metrics to Keep Pitchers Healthy")

    st.markdown("""
    Based on sports science and biomechanical research, the most important metrics to monitor are:

    â€¢ **Velocity trends** (sudden drop may indicate fatigue or injury)  
    â€¢ **Spin rate stability**  
    â€¢ **Release point consistency (height & side variance)**  
    â€¢ **Pitch workload volume**  
    â€¢ **Hard contact allowed (exit velocity spikes)**  
    â€¢ **Vertical break changes (may indicate mechanical drift)**  

    The strongest early injury predictors:
    1. Release point drift
    2. Spin rate decline
    3. Velocity loss
    """)

    st.subheader("ğŸ“ˆ Visualizations")

    st.line_chart(df["velocity_mph"])
    st.line_chart(df["spin_rate_rpm"])
    st.line_chart(df["release_height_ft"])
    st.line_chart(df["release_side_ft"])

else:
    st.info("Upload a CSV file to begin analysis.")
